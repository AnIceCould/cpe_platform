<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶ä¸¢åŒ…è­¦æŠ¥</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 2rem; }
        .container { max-width: 800px; margin: auto; }
        h1 { color: #bb86fc; border-bottom: 2px solid #333; padding-bottom: 10px; }
        #status { background-color: #333; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }

        #alerts { display: flex; flex-direction: column-reverse; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>å®æ—¶ä¸¢åŒ…è­¦æŠ¥ç›‘æ§</h1>
        <div id="status">è¿æ¥çŠ¶æ€: æ­£åœ¨è¿æ¥...</div>
        <div id="alerts">
            <!-- è­¦æŠ¥å°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ -->
        </div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const alertsContainer = document.getElementById('alerts');
        const wsUrl = 'ws://localhost:8080/ws/alerts';

        function connect() {
            const socket = new WebSocket(wsUrl);

            socket.onopen = function() {
                console.log('WebSocket è¿æ¥å·²å»ºç«‹');
                statusDiv.textContent = 'è¿æ¥çŠ¶æ€: å·²è¿æ¥';
                statusDiv.className = 'status-connected';
            };

            socket.onmessage = function(event) {
                console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
                const alertData = JSON.parse(event.data);
                
                const alertElement = document.createElement('div');
                alertElement.className = 'alert';
                
                const header = document.createElement('div');
                header.className = 'alert-header';
                header.textContent = `ğŸš¨ æ£€æµ‹åˆ°ä¸¢åŒ…äº‹ä»¶ï¼`;
                
                const body = document.createElement('div');
                body.className = 'alert-body';

                // ã€ã€ã€æ ¸å¿ƒä¿®æ”¹ã€‘ã€‘ã€‘
                // æˆ‘ä»¬ä¸å†ä½¿ç”¨ toLocaleString()ï¼Œè€Œæ˜¯è‡ªå®šä¹‰æ ¼å¼åŒ–å‡½æ•°ä»¥ç¡®ä¿æ¯«ç§’çš„æ˜¾ç¤ºã€‚
                const eventDate = new Date(alertData.predictionTimestamp);

                // ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œç”¨äºç»™æ•°å­—è¡¥é›¶ (ä¾‹å¦‚ 5 -> "05")
                const pad = (num, size = 2) => String(num).padStart(size, '0');

                // æ‰‹åŠ¨æ‹¼æ¥æ—¥æœŸå’Œæ—¶é—´å­—ç¬¦ä¸²
                const year = eventDate.getFullYear();
                const month = pad(eventDate.getMonth() + 1); // æœˆä»½æ˜¯ä»0å¼€å§‹çš„
                const day = pad(eventDate.getDate());
                const hours = pad(eventDate.getHours());
                const minutes = pad(eventDate.getMinutes());
                const seconds = pad(eventDate.getSeconds());
                const milliseconds = pad(eventDate.getMilliseconds(), 3); // æ¯«ç§’éœ€è¦è¡¥åˆ°3ä½

                const formattedTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
                
                body.innerHTML = `
                    è®¾å¤‡ID: ${alertData.deviceId}<br>
                    äº‹ä»¶æ—¶é—´: ${formattedTime}
                `;
                
                alertElement.appendChild(header);
                alertElement.appendChild(body);
                
                alertsContainer.prepend(alertElement); // å°†æ–°è­¦æŠ¥æ”¾åœ¨æœ€ä¸Šé¢
            };

            socket.onclose = function() {
                console.log('WebSocket è¿æ¥å·²å…³é—­. æ­£åœ¨å°è¯•é‡æ–°è¿æ¥...');
                statusDiv.textContent = 'è¿æ¥çŠ¶æ€: å·²æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...';
                statusDiv.className = 'status-disconnected';
                // 3ç§’åå°è¯•é‡è¿
                setTimeout(connect, 3000);
            };

            socket.onerror = function(error) {
                console.error('WebSocket é”™è¯¯:', error);
            };
        }

        // é¦–æ¬¡è¿æ¥
        connect();
    </script>
</body>
</html>

